<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1">  1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T18U3">J</span> = fitNGaussians3D_mexCode_J(<span class="var type1" id="S3T1U6">x0</span>,<span class="var type1" id="S4T1U7">image</span>,<span class="var type1" id="S5T14U8">index</span>,<span class="var type1" id="S6T9U9">psfSigma</span>) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2">  2</a></span><span class="line"><span class="comment">% Edit of fitNGaussians2D to work in 3D</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3">  3</a></span><span class="line"><span class="comment">%   EHarry March 2012</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5">  5</a></span><span class="line"><span class="comment">%% ORIGINAL HEADER</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6">  6</a></span><span class="line"><span class="comment">% % %FITNGAUSSIANS2D yields F, the difference between an image and a theoretical image produced by N Gaussians, and J, the Jacobian of F.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7">  7</a></span><span class="line"><span class="comment">% % %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8">  8</a></span><span class="line"><span class="comment">% % %SYNOPSIS [F,J] = fitNGaussians2D(x0,image,index,psfSigma)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9">  9</a></span><span class="line"><span class="comment">% % %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10"> 10</a></span><span class="line"><span class="comment">% % %INPUT  x0      : initial guess of PSF positions and amplitudes and</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11"> 11</a></span><span class="line"><span class="comment">% % %                 background noise.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12"> 12</a></span><span class="line"><span class="comment">% % %       image   : Image part being analyzed.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13"> 13</a></span><span class="line"><span class="comment">% % %       index   : x,y-indices of pixels considered.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14"> 14</a></span><span class="line"><span class="comment">% % %       psfSigma: Standard deviation of point spread function (in pixels).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15"> 15</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16"> 16</a></span><span class="line"><span class="comment">% % %OUTPUT F       : Residuals from fitting an image with supplied</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17"> 17</a></span><span class="line"><span class="comment">% % %                 Gaussians.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18"> 18</a></span><span class="line"><span class="comment">% % %       J       : The Jacobian matrix of F.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19"> 19</a></span><span class="line"><span class="comment">% % %       errFlag : 0 if function executes normally, 1 otherwise.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20"> 20</a></span><span class="line"><span class="comment">% % %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21"> 21</a></span><span class="line"><span class="comment">% % %REMARKS F = model image - real image, important to know if the sign of the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22"> 22</a></span><span class="line"><span class="comment">% % %residuals matters.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23"> 23</a></span><span class="line"><span class="comment">% % %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24"> 24</a></span><span class="line"><span class="comment">% % %Khuloud Jaqaman, August 2005</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26"> 26</a></span><span class="line"><span class="comment">%% Output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27"> 27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,28"> 28</a></span><span class="line"><span class="comment">%coder.extrinsic('sparse');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30"> 30</a></span><span class="line"><span class="mxinfo" id="T18:U6"><span class="var type1" id="S2T18U12">J</span> = <span class="mxinfo" id="T26:U8">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32"> 32</a></span><span class="line"><span class="comment">%% Input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34"> 34</a></span><span class="line"><span class="comment">% %check whether correct number of input arguments was used</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35"> 35</a></span><span class="line"><span class="comment">% if nargin ~= 4</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36"> 36</a></span><span class="line"><span class="comment">%     disp('--fitNGaussians2D: Incorrect number of input arguments!');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37"> 37</a></span><span class="line"><span class="comment">%     return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38"> 38</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39"> 39</a></span><span class="line"><span class="comment">%check whether correct number of input arguments was used</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40"> 40</a></span><span class="line"><span class="keyword">if</span> nargin ~= 4</span></span>
<span class="srcline"><span class="lineno"><a href="1,41"> 41</a></span><span class="line">    disp(<span class="string">'--fitNGaussians3D: Incorrect number of input arguments!'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,42"> 42</a></span><span class="line">    <span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43"> 43</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45"> 45</a></span><span class="line"><span class="comment">%% Calculating F &amp; J</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47"> 47</a></span><span class="line"><span class="comment">%extract background intensity from x0 and remove from vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48"> 48</a></span><span class="line"><span class="comment">% bgAmp = x0(end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49"> 49</a></span><span class="line"><span class="mxinfo" id="T1:U9"><span class="var type1" id="S3T1U28">x0</span> = <span class="mxinfo" id="T1:U11"><span class="var type1" id="S3T1U30">x0</span>(<span class="mxinfo" id="T30:U13"><span class="mxinfo" id="T2:U14">1</span>:<span class="mxinfo" id="T2:U15"><span class="mxinfo" id="T2:U16">end</span>-<span class="mxinfo" id="T2:U17">1</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50"> 50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,51"> 51</a></span><span class="line"><span class="comment">%get number of PSFs considered</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52"> 52</a></span><span class="line"><span class="comment">% numPSF = length(x0)/3;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53"> 53</a></span><span class="line"><span class="mxinfo" id="T2:U18"><span class="var type1" id="S10T2U39">numPSF</span> = <span class="mxinfo" id="T2:U20"><span class="mxinfo" id="T2:U21">length(<span class="var type1" id="S3T1U43">x0</span>)</span>/<span class="mxinfo" id="T2:U23">4</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54"> 54</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,55"> 55</a></span><span class="line"><span class="comment">% %reshape 3nx1 vector x0 into nx3 matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56"> 56</a></span><span class="line"><span class="comment">% x0 = reshape(x0,3,numPSF);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57"> 57</a></span><span class="line"><span class="comment">% x0 = x0';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58"> 58</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,59"> 59</a></span><span class="line"><span class="comment">%reshape 4nx1 vector x0 into nx4 matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60"> 60</a></span><span class="line"><span class="mxinfo" id="T12:U24"><span class="var type1" id="S3T12U47">x0</span> = <span class="mxinfo" id="T12:U26">reshape(<span class="var type1" id="S3T1U50">x0</span>,4,<span class="var type1" id="S10T2U52">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61"> 61</a></span><span class="line"><span class="mxinfo" id="T13:U29"><span class="var type1" id="S3T13U55">x0</span> = <span class="mxinfo" id="T13:U31"><span class="var type1" id="S3T12U57">x0</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62"> 62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,63"> 63</a></span><span class="line"><span class="comment">%extract PSF center positions and amplitudes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64"> 64</a></span><span class="line"><span class="comment">% psfPos = x0(:,1:2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65"> 65</a></span><span class="line"><span class="comment">% psfAmp = x0(:,3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66"> 66</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,67"> 67</a></span><span class="line"><span class="mxinfo" id="T14:U33"><span class="var type1" id="S13T14U60">psfPos</span> = <span class="mxinfo" id="T14:U35"><span class="var type1" id="S3T13U62">x0</span>(<span class="mxinfo" id="T30:U37">:</span>,<span class="mxinfo" id="T31:U38"><span class="mxinfo" id="T2:U39">1</span>:<span class="mxinfo" id="T2:U40">3</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,68"> 68</a></span><span class="line"><span class="mxinfo" id="T1:U41"><span class="var type1" id="S14T1U69">psfAmp</span> = <span class="mxinfo" id="T1:U43"><span class="var type1" id="S3T13U71">x0</span>(<span class="mxinfo" id="T30:U45">:</span>,<span class="mxinfo" id="T2:U46">4</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69"> 69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,70"> 70</a></span><span class="line"><span class="comment">%find minimum and maximum pixel indices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71"> 71</a></span><span class="line"><span class="mxinfo" id="T2:U47"><span class="var type1" id="S15T2U76">minIndxX</span> = <span class="mxinfo" id="T2:U49">min(<span class="mxinfo" id="T1:U50"><span class="var type1" id="S5T14U80">index</span>(<span class="mxinfo" id="T30:U52">:</span>,<span class="mxinfo" id="T2:U53">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,72"> 72</a></span><span class="line"><span class="mxinfo" id="T2:U54"><span class="var type1" id="S17T2U85">maxIndxX</span> = <span class="mxinfo" id="T2:U56">max(<span class="mxinfo" id="T1:U57"><span class="var type1" id="S5T14U89">index</span>(<span class="mxinfo" id="T30:U59">:</span>,<span class="mxinfo" id="T2:U60">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73"> 73</a></span><span class="line"><span class="mxinfo" id="T2:U61"><span class="var type1" id="S19T2U94">minIndxY</span> = <span class="mxinfo" id="T2:U63">min(<span class="mxinfo" id="T1:U64"><span class="var type1" id="S5T14U98">index</span>(<span class="mxinfo" id="T30:U66">:</span>,<span class="mxinfo" id="T2:U67">2</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74"> 74</a></span><span class="line"><span class="mxinfo" id="T2:U68"><span class="var type1" id="S20T2U103">maxIndxY</span> = <span class="mxinfo" id="T2:U70">max(<span class="mxinfo" id="T1:U71"><span class="var type1" id="S5T14U107">index</span>(<span class="mxinfo" id="T30:U73">:</span>,<span class="mxinfo" id="T2:U74">2</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75"> 75</a></span><span class="line"><span class="mxinfo" id="T2:U75"><span class="var type1" id="S21T2U112">minIndxZ</span> = <span class="mxinfo" id="T2:U77">min(<span class="mxinfo" id="T1:U78"><span class="var type1" id="S5T14U116">index</span>(<span class="mxinfo" id="T30:U80">:</span>,<span class="mxinfo" id="T2:U81">3</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76"> 76</a></span><span class="line"><span class="mxinfo" id="T2:U82"><span class="var type1" id="S22T2U121">maxIndxZ</span> = <span class="mxinfo" id="T2:U84">max(<span class="mxinfo" id="T1:U85"><span class="var type1" id="S5T14U125">index</span>(<span class="mxinfo" id="T30:U87">:</span>,<span class="mxinfo" id="T2:U88">3</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77"> 77</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,78"> 78</a></span><span class="line"><span class="comment">%determine the contribution of each PSF (assuming amplitude 1) to a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79"> 79</a></span><span class="line"><span class="comment">%pixel based on its x-coordinate (needed to calculate F &amp; J)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80"> 80</a></span><span class="line"><span class="mxinfo" id="T18:U89"><span class="var type1" id="S23T18U130">psfIntegX</span> = <span class="mxinfo" id="T18:U91">zeros(<span class="mxinfo" id="T2:U92"><span class="mxinfo" id="T2:U93"><span class="var type1" id="S17T2U135">maxIndxX</span>-<span class="var type1" id="S15T2U136">minIndxX</span></span>+<span class="mxinfo" id="T2:U96">1</span></span>,<span class="var type1" id="S10T2U138">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81"> 81</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S25T2U141">i</span>=<span class="mxinfo" id="T2:U99">1</span>:<span class="var type1" id="S10T2U144">numPSF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82"> 82</a></span><span class="line">    <span class="mxinfo" id="T25:U101"><span class="var type1" id="S26T25U147">temp</span> = <span class="mxinfo" id="T25:U103"><span class="fcn" id="F167N2:B149">GaussListND_mexCode</span>(<span class="mxinfo" id="T1:U104">(<span class="mxinfo" id="T17:U105"><span class="var type1" id="S15T2U153">minIndxX</span>:<span class="var type1" id="S17T2U154">maxIndxX</span></span>)'</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83"> 83</a></span><span class="line"><span class="mxinfo" id="T25:U101"><span class="mxinfo" id="T25:U103">        <span class="mxinfo" id="T2:U108"><span class="var type1" id="S6T9U156">psfSigma</span>(<span class="mxinfo" id="T2:U110">1</span>)</span>,<span class="mxinfo" id="T2:U111"><span class="var type1" id="S13T14U159">psfPos</span>(<span class="var type1" id="S25T2U160">i</span>,<span class="mxinfo" id="T2:U114">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84"> 84</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,85"> 85</a></span><span class="line">    <span class="mxinfo" id="T18:U115"><span class="var type1" id="S28T18U164">temp2</span> = <span class="mxinfo" id="T18:U117">squeeze(<span class="var type1" id="S26T25U167">temp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86"> 86</a></span><span class="line">    <span class="comment">%clear temp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87"> 87</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,88"> 88</a></span><span class="line">    <span class="mxinfo" id="T1:U119"><span class="mxinfo" id="T1:U120"><span class="var type1" id="S23T18U171">psfIntegX</span>(<span class="mxinfo" id="T30:U122">:</span>,<span class="var type1" id="S25T2U173">i</span>)</span> = <span class="mxinfo" id="T1:U124"><span class="var type1" id="S28T18U175">temp2</span>(<span class="mxinfo" id="T30:U126">:</span>,<span class="mxinfo" id="T2:U127">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89"> 89</a></span><span class="line">    <span class="comment">%clear temp2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90"> 90</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91"> 91</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,92"> 92</a></span><span class="line"><span class="comment">%determine the contribution of each PSF (assuming amplitude 1) to a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93"> 93</a></span><span class="line"><span class="comment">%pixel based on its y-coordinate (needed to calculate F &amp; J)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94"> 94</a></span><span class="line"><span class="mxinfo" id="T18:U128"><span class="var type1" id="S30T18U180">psfIntegY</span> = <span class="mxinfo" id="T18:U130">zeros(<span class="mxinfo" id="T2:U131"><span class="mxinfo" id="T2:U132"><span class="var type1" id="S20T2U185">maxIndxY</span>-<span class="var type1" id="S19T2U186">minIndxY</span></span>+<span class="mxinfo" id="T2:U135">1</span></span>,<span class="var type1" id="S10T2U188">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,95"> 95</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S25T2U191">i</span>=<span class="mxinfo" id="T2:U138">1</span>:<span class="var type1" id="S10T2U194">numPSF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96"> 96</a></span><span class="line">    <span class="mxinfo" id="T25:U140"><span class="var type1" id="S26T25U197">temp</span> = <span class="mxinfo" id="T25:U142"><span class="fcn" id="F167N2:B199">GaussListND_mexCode</span>(<span class="mxinfo" id="T1:U143">(<span class="mxinfo" id="T17:U144"><span class="var type1" id="S19T2U203">minIndxY</span>:<span class="var type1" id="S20T2U204">maxIndxY</span></span>)'</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97"> 97</a></span><span class="line"><span class="mxinfo" id="T25:U140"><span class="mxinfo" id="T25:U142">        <span class="mxinfo" id="T2:U147"><span class="var type1" id="S6T9U206">psfSigma</span>(<span class="mxinfo" id="T2:U149">1</span>)</span>,<span class="mxinfo" id="T2:U150"><span class="var type1" id="S13T14U209">psfPos</span>(<span class="var type1" id="S25T2U210">i</span>,<span class="mxinfo" id="T2:U153">2</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,98"> 98</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,99"> 99</a></span><span class="line">    <span class="mxinfo" id="T18:U154"><span class="var type1" id="S28T18U214">temp2</span> = <span class="mxinfo" id="T18:U156">squeeze(<span class="var type1" id="S26T25U217">temp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100">100</a></span><span class="line">    <span class="comment">%clear temp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101">101</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,102">102</a></span><span class="line">    <span class="mxinfo" id="T1:U158"><span class="mxinfo" id="T1:U159"><span class="var type1" id="S30T18U221">psfIntegY</span>(<span class="mxinfo" id="T30:U161">:</span>,<span class="var type1" id="S25T2U223">i</span>)</span> = <span class="mxinfo" id="T1:U163"><span class="var type1" id="S28T18U225">temp2</span>(<span class="mxinfo" id="T30:U165">:</span>,<span class="mxinfo" id="T2:U166">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,103">103</a></span><span class="line">    <span class="comment">%clear temp2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104">104</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105">105</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,106">106</a></span><span class="line"><span class="comment">%determine the contribution of each PSF (assuming amplitude 1) to a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107">107</a></span><span class="line"><span class="comment">%pixel based on its z-coordinate (needed to calculate F &amp; J)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108">108</a></span><span class="line"><span class="mxinfo" id="T18:U167"><span class="var type1" id="S31T18U230">psfIntegZ</span> = <span class="mxinfo" id="T18:U169">zeros(<span class="mxinfo" id="T2:U170"><span class="mxinfo" id="T2:U171"><span class="var type1" id="S22T2U235">maxIndxZ</span>-<span class="var type1" id="S21T2U236">minIndxZ</span></span>+<span class="mxinfo" id="T2:U174">1</span></span>,<span class="var type1" id="S10T2U238">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109">109</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S25T2U241">i</span>=<span class="mxinfo" id="T2:U177">1</span>:<span class="var type1" id="S10T2U244">numPSF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110">110</a></span><span class="line">    <span class="mxinfo" id="T25:U179"><span class="var type1" id="S26T25U247">temp</span> = <span class="mxinfo" id="T25:U181"><span class="fcn" id="F167N2:B249">GaussListND_mexCode</span>(<span class="mxinfo" id="T1:U182">(<span class="mxinfo" id="T17:U183"><span class="var type1" id="S21T2U253">minIndxZ</span>:<span class="var type1" id="S22T2U254">maxIndxZ</span></span>)'</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111">111</a></span><span class="line"><span class="mxinfo" id="T25:U179"><span class="mxinfo" id="T25:U181">        <span class="mxinfo" id="T2:U186"><span class="var type1" id="S6T9U256">psfSigma</span>(<span class="mxinfo" id="T2:U188">2</span>)</span>,<span class="mxinfo" id="T2:U189"><span class="var type1" id="S13T14U259">psfPos</span>(<span class="var type1" id="S25T2U260">i</span>,<span class="mxinfo" id="T2:U192">3</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112">112</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,113">113</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,114">114</a></span><span class="line">    <span class="mxinfo" id="T18:U193"><span class="var type1" id="S28T18U264">temp2</span> = <span class="mxinfo" id="T18:U195">squeeze(<span class="var type1" id="S26T25U267">temp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115">115</a></span><span class="line">    <span class="comment">%clear temp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116">116</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,117">117</a></span><span class="line">    <span class="mxinfo" id="T1:U197"><span class="mxinfo" id="T1:U198"><span class="var type1" id="S31T18U271">psfIntegZ</span>(<span class="mxinfo" id="T30:U200">:</span>,<span class="var type1" id="S25T2U273">i</span>)</span> = <span class="mxinfo" id="T1:U202"><span class="var type1" id="S28T18U275">temp2</span>(<span class="mxinfo" id="T30:U204">:</span>,<span class="mxinfo" id="T2:U205">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,118">118</a></span><span class="line">    <span class="comment">%clear temp2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119">119</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120">120</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,121">121</a></span><span class="line"><span class="comment">%calculate the value of each PSF (assuming amplitude 1) at the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122">122</a></span><span class="line"><span class="comment">%x-coordinates of the corners of all pixels (needed to calculate J)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123">123</a></span><span class="line"><span class="mxinfo" id="T18:U206"><span class="var type1" id="S32T18U280">psfValueX</span> = <span class="mxinfo" id="T18:U208">zeros(<span class="mxinfo" id="T2:U209"><span class="mxinfo" id="T2:U210"><span class="var type1" id="S17T2U285">maxIndxX</span>-<span class="var type1" id="S15T2U286">minIndxX</span></span>+<span class="mxinfo" id="T2:U213">2</span></span>,<span class="var type1" id="S10T2U288">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124">124</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S25T2U291">i</span>=<span class="mxinfo" id="T2:U216">1</span>:<span class="var type1" id="S10T2U294">numPSF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125">125</a></span><span class="line">    <span class="mxinfo" id="T1:U218"><span class="mxinfo" id="T1:U219"><span class="var type1" id="S32T18U298">psfValueX</span>(<span class="mxinfo" id="T30:U221">:</span>,<span class="var type1" id="S25T2U300">i</span>)</span> = <span class="mxinfo" id="T1:U223">exp(<span class="mxinfo" id="T1:U224"><span class="mxinfo" id="T1:U225"><span class="mxinfo" id="T1:U226">-<span class="mxinfo" id="T1:U227">(<span class="mxinfo" id="T1:U228"><span class="mxinfo" id="T1:U229">(<span class="mxinfo" id="T17:U230"><span class="mxinfo" id="T2:U231"><span class="var type1" id="S15T2U313">minIndxX</span>-<span class="mxinfo" id="T2:U233">0.5</span></span>:<span class="mxinfo" id="T2:U234"><span class="var type1" id="S17T2U316">maxIndxX</span>+<span class="mxinfo" id="T2:U236">0.5</span></span></span>)'</span><span class="keyword">...</span></span></span></span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126">126</a></span><span class="line"><span class="mxinfo" id="T1:U218"><span class="mxinfo" id="T1:U223"><span class="mxinfo" id="T1:U224"><span class="mxinfo" id="T1:U225"><span class="mxinfo" id="T1:U226"><span class="mxinfo" id="T1:U227"><span class="mxinfo" id="T1:U228">        -<span class="mxinfo" id="T2:U237"><span class="var type1" id="S13T14U319">psfPos</span>(<span class="var type1" id="S25T2U320">i</span>,<span class="mxinfo" id="T2:U240">1</span>)</span></span>).^2</span></span>/<span class="mxinfo" id="T2:U241">2</span></span>/<span class="mxinfo" id="T2:U242"><span class="mxinfo" id="T2:U243"><span class="var type1" id="S6T9U326">psfSigma</span>(<span class="mxinfo" id="T2:U245">1</span>)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127">127</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128">128</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,129">129</a></span><span class="line"><span class="comment">%calculate the value of each PSF (assuming amplitude 1) at the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130">130</a></span><span class="line"><span class="comment">%y-coordinates of the corners of all pixels (needed to calculate J)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131">131</a></span><span class="line"><span class="mxinfo" id="T18:U246"><span class="var type1" id="S34T18U331">psfValueY</span> = <span class="mxinfo" id="T18:U248">zeros(<span class="mxinfo" id="T2:U249"><span class="mxinfo" id="T2:U250"><span class="var type1" id="S20T2U336">maxIndxY</span>-<span class="var type1" id="S19T2U337">minIndxY</span></span>+<span class="mxinfo" id="T2:U253">2</span></span>,<span class="var type1" id="S10T2U339">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132">132</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S25T2U342">i</span>=<span class="mxinfo" id="T2:U256">1</span>:<span class="var type1" id="S10T2U345">numPSF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133">133</a></span><span class="line">    <span class="mxinfo" id="T1:U258"><span class="mxinfo" id="T1:U259"><span class="var type1" id="S34T18U349">psfValueY</span>(<span class="mxinfo" id="T30:U261">:</span>,<span class="var type1" id="S25T2U351">i</span>)</span> = <span class="mxinfo" id="T1:U263">exp(<span class="mxinfo" id="T1:U264"><span class="mxinfo" id="T1:U265"><span class="mxinfo" id="T1:U266">-<span class="mxinfo" id="T1:U267">(<span class="mxinfo" id="T1:U268"><span class="mxinfo" id="T1:U269">(<span class="mxinfo" id="T17:U270"><span class="mxinfo" id="T2:U271"><span class="var type1" id="S19T2U364">minIndxY</span>-<span class="mxinfo" id="T2:U273">0.5</span></span>:<span class="mxinfo" id="T2:U274"><span class="var type1" id="S20T2U367">maxIndxY</span>+<span class="mxinfo" id="T2:U276">0.5</span></span></span>)'</span><span class="keyword">...</span></span></span></span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134">134</a></span><span class="line"><span class="mxinfo" id="T1:U258"><span class="mxinfo" id="T1:U263"><span class="mxinfo" id="T1:U264"><span class="mxinfo" id="T1:U265"><span class="mxinfo" id="T1:U266"><span class="mxinfo" id="T1:U267"><span class="mxinfo" id="T1:U268">        -<span class="mxinfo" id="T2:U277"><span class="var type1" id="S13T14U370">psfPos</span>(<span class="var type1" id="S25T2U371">i</span>,<span class="mxinfo" id="T2:U280">2</span>)</span></span>).^2</span></span>/<span class="mxinfo" id="T2:U281">2</span></span>/<span class="mxinfo" id="T2:U282"><span class="mxinfo" id="T2:U283"><span class="var type1" id="S6T9U377">psfSigma</span>(<span class="mxinfo" id="T2:U285">1</span>)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,135">135</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136">136</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,137">137</a></span><span class="line"><span class="comment">%calculate the value of each PSF (assuming amplitude 1) at the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138">138</a></span><span class="line"><span class="comment">%z-coordinates of the corners of all pixels (needed to calculate J)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139">139</a></span><span class="line"><span class="mxinfo" id="T18:U286"><span class="var type1" id="S35T18U382">psfValueZ</span> = <span class="mxinfo" id="T18:U288">zeros(<span class="mxinfo" id="T2:U289"><span class="mxinfo" id="T2:U290"><span class="var type1" id="S22T2U387">maxIndxZ</span>-<span class="var type1" id="S21T2U388">minIndxZ</span></span>+<span class="mxinfo" id="T2:U293">2</span></span>,<span class="var type1" id="S10T2U390">numPSF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,140">140</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S25T2U393">i</span>=<span class="mxinfo" id="T2:U296">1</span>:<span class="var type1" id="S10T2U396">numPSF</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141">141</a></span><span class="line">    <span class="mxinfo" id="T1:U298"><span class="mxinfo" id="T1:U299"><span class="var type1" id="S35T18U400">psfValueZ</span>(<span class="mxinfo" id="T30:U301">:</span>,<span class="var type1" id="S25T2U402">i</span>)</span> = <span class="mxinfo" id="T1:U303">exp(<span class="mxinfo" id="T1:U304"><span class="mxinfo" id="T1:U305"><span class="mxinfo" id="T1:U306">-<span class="mxinfo" id="T1:U307">(<span class="mxinfo" id="T1:U308"><span class="mxinfo" id="T1:U309">(<span class="mxinfo" id="T17:U310"><span class="mxinfo" id="T2:U311"><span class="var type1" id="S21T2U415">minIndxZ</span>-<span class="mxinfo" id="T2:U313">0.5</span></span>:<span class="mxinfo" id="T2:U314"><span class="var type1" id="S22T2U418">maxIndxZ</span>+<span class="mxinfo" id="T2:U316">0.5</span></span></span>)'</span><span class="keyword">...</span></span></span></span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142">142</a></span><span class="line"><span class="mxinfo" id="T1:U298"><span class="mxinfo" id="T1:U303"><span class="mxinfo" id="T1:U304"><span class="mxinfo" id="T1:U305"><span class="mxinfo" id="T1:U306"><span class="mxinfo" id="T1:U307"><span class="mxinfo" id="T1:U308">        -<span class="mxinfo" id="T2:U317"><span class="var type1" id="S13T14U421">psfPos</span>(<span class="var type1" id="S25T2U422">i</span>,<span class="mxinfo" id="T2:U320">3</span>)</span></span>).^2</span></span>/<span class="mxinfo" id="T2:U321">2</span></span>/<span class="mxinfo" id="T2:U322"><span class="mxinfo" id="T2:U323"><span class="var type1" id="S6T9U428">psfSigma</span>(<span class="mxinfo" id="T2:U325">2</span>)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143">143</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144">144</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,145">145</a></span><span class="line"><span class="comment">%get number of pixels in image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146">146</a></span><span class="line"><span class="mxinfo" id="T2:U326"><span class="var type1" id="S36T2U433">numPixel</span> = <span class="mxinfo" id="T2:U328">length(<span class="var type1" id="S4T1U436">image</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,147">147</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,148">148</a></span><span class="line"><span class="comment">% %get xy-indices relative to minimum</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149">149</a></span><span class="line"><span class="comment">% relIndxX = index(:,1) - minIndxX + 1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150">150</a></span><span class="line"><span class="comment">% relIndxY = index(:,2) - minIndxY + 1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151">151</a></span><span class="line"><span class="comment">%get xy-indices relative to minimum</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152">152</a></span><span class="line"><span class="mxinfo" id="T1:U330"><span class="var type1" id="S37T1U439">relIndxX</span> = <span class="mxinfo" id="T1:U332"><span class="mxinfo" id="T1:U333"><span class="mxinfo" id="T1:U334"><span class="var type1" id="S5T14U443">index</span>(<span class="mxinfo" id="T30:U336">:</span>,<span class="mxinfo" id="T2:U337">1</span>)</span> - <span class="var type1" id="S15T2U446">minIndxX</span></span> + <span class="mxinfo" id="T2:U339">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,153">153</a></span><span class="line"><span class="mxinfo" id="T1:U340"><span class="var type1" id="S38T1U450">relIndxY</span> = <span class="mxinfo" id="T1:U342"><span class="mxinfo" id="T1:U343"><span class="mxinfo" id="T1:U344"><span class="var type1" id="S5T14U454">index</span>(<span class="mxinfo" id="T30:U346">:</span>,<span class="mxinfo" id="T2:U347">2</span>)</span> - <span class="var type1" id="S19T2U457">minIndxY</span></span> + <span class="mxinfo" id="T2:U349">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,154">154</a></span><span class="line"><span class="mxinfo" id="T1:U350"><span class="var type1" id="S39T1U461">relIndxZ</span> = <span class="mxinfo" id="T1:U352"><span class="mxinfo" id="T1:U353"><span class="mxinfo" id="T1:U354"><span class="var type1" id="S5T14U465">index</span>(<span class="mxinfo" id="T30:U356">:</span>,<span class="mxinfo" id="T2:U357">3</span>)</span> - <span class="var type1" id="S21T2U468">minIndxZ</span></span> + <span class="mxinfo" id="T2:U359">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,155">155</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,156">156</a></span><span class="line"><span class="comment">% %calculate the value of F at all pixels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157">157</a></span><span class="line"><span class="comment">% F = (sum(repmat(psfAmp,1,numPixel).*psfIntegX(relIndxX,:)'.*psfIntegY(relIndxY,:)',1))' <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158">158</a></span><span class="line"><span class="comment">%     + repmat(bgAmp,numPixel,1) - image;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159">159</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,160">160</a></span><span class="line"><span class="comment">%calculate the value of F at all pixels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161">161</a></span><span class="line"><span class="comment">% F = (sum(repmat(psfAmp,1,numPixel).*psfIntegX(relIndxX,:)'.*psfIntegY(relIndxY,:)'.*psfIntegZ(relIndxZ,:)',1))' <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162">162</a></span><span class="line"><span class="comment">%     + repmat(bgAmp,numPixel,1) - image;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164">164</a></span><span class="line"><span class="comment">%remove pixels with NaN (which means they are out of the cropped image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,165">165</a></span><span class="line"><span class="comment">%area)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,166">166</a></span><span class="line"><span class="mxinfo" id="T29:U360"><span class="var type1" id="S40T29U472">indxPixel</span> = <span class="mxinfo" id="T29:U362">~<span class="mxinfo" id="T29:U363">isnan(<span class="var type1" id="S4T1U476">image</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,168">168</a></span><span class="line"><span class="comment">% F = F(indxPixel);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169">169</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,170">170</a></span><span class="line"><span class="comment">% if nargout &gt; 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171">171</a></span><span class="line"><span class="comment">%calculate the derivative at all pixels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172">172</a></span><span class="line"><span class="comment">%     J = ones(numPixel,3*numPSF+1); %(last column for background amplitude)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173">173</a></span><span class="line"><span class="comment">%     J(:,1:3:3*numPSF) = repmat(psfAmp',numPixel,1).*(psfValueX(relIndxX,:)-<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174">174</a></span><span class="line"><span class="comment">%         psfValueX(relIndxX+1,:)).*psfIntegY(relIndxY,:); %w.r.t. x</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175">175</a></span><span class="line"><span class="comment">%     J(:,2:3:3*numPSF) = repmat(psfAmp',numPixel,1).*(psfValueY(relIndxY,:)-<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176">176</a></span><span class="line"><span class="comment">%         psfValueY(relIndxY+1,:)).*psfIntegX(relIndxX,:); %w.r.t. y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,177">177</a></span><span class="line"><span class="comment">%     J(:,3:3:3*numPSF) = psfIntegX(relIndxX,:).*psfIntegY(relIndxY,:); %w.r.t. amp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178">178</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,179">179</a></span><span class="line"><span class="mxinfo" id="T18:U365"><span class="var type1" id="S2T18U479">J</span> = <span class="mxinfo" id="T18:U367">ones(<span class="var type1" id="S36T2U482">numPixel</span>,<span class="mxinfo" id="T2:U369"><span class="mxinfo" id="T2:U370"><span class="mxinfo" id="T2:U371">4</span>*<span class="var type1" id="S10T2U486">numPSF</span></span>+<span class="mxinfo" id="T2:U373">1</span></span>)</span></span>; <span class="comment">%(last column for background amplitude)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180">180</a></span><span class="line"><span class="mxinfo" id="T18:U374"><span class="mxinfo" id="T18:U375"><span class="var type1" id="S2T18U491">J</span>(<span class="mxinfo" id="T30:U377">:</span>,<span class="mxinfo" id="T30:U378"><span class="mxinfo" id="T2:U379">1</span>:<span class="mxinfo" id="T2:U380">4</span>:<span class="mxinfo" id="T2:U381"><span class="mxinfo" id="T2:U382">4</span>*<span class="var type1" id="S10T2U499">numPSF</span></span></span>)</span> = <span class="mxinfo" id="T18:U384"><span class="mxinfo" id="T18:U385"><span class="mxinfo" id="T18:U386"><span class="mxinfo" id="T18:U387">repmat(<span class="mxinfo" id="T17:U388"><span class="var type1" id="S14T1U506">psfAmp</span>'</span>,<span class="var type1" id="S36T2U507">numPixel</span>,1)</span>.*(<span class="mxinfo" id="T18:U391"><span class="mxinfo" id="T18:U392"><span class="var type1" id="S32T18U512">psfValueX</span>(<span class="var type1" id="S37T1U513">relIndxX</span>,<span class="mxinfo" id="T30:U395">:</span>)</span>-<span class="keyword">...</span></span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181">181</a></span><span class="line"><span class="mxinfo" id="T18:U374"><span class="mxinfo" id="T18:U384"><span class="mxinfo" id="T18:U385"><span class="mxinfo" id="T18:U386"><span class="mxinfo" id="T18:U391">    <span class="mxinfo" id="T18:U396"><span class="var type1" id="S32T18U516">psfValueX</span>(<span class="mxinfo" id="T30:U398"><span class="var type1" id="S37T1U518">relIndxX</span>+<span class="mxinfo" id="T2:U400">1</span></span>,<span class="mxinfo" id="T30:U401">:</span>)</span></span>)</span>.*<span class="mxinfo" id="T18:U402"><span class="var type1" id="S30T18U522">psfIntegY</span>(<span class="var type1" id="S38T1U523">relIndxY</span>,<span class="mxinfo" id="T30:U405">:</span>)</span></span>.*<span class="mxinfo" id="T18:U406"><span class="var type1" id="S31T18U526">psfIntegZ</span>(<span class="var type1" id="S39T1U527">relIndxZ</span>,<span class="mxinfo" id="T30:U409">:</span>)</span></span></span>; <span class="comment">%w.r.t. x</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182">182</a></span><span class="line"><span class="mxinfo" id="T18:U410"><span class="mxinfo" id="T18:U411"><span class="var type1" id="S2T18U532">J</span>(<span class="mxinfo" id="T30:U413">:</span>,<span class="mxinfo" id="T30:U414"><span class="mxinfo" id="T2:U415">2</span>:<span class="mxinfo" id="T2:U416">4</span>:<span class="mxinfo" id="T2:U417"><span class="mxinfo" id="T2:U418">4</span>*<span class="var type1" id="S10T2U540">numPSF</span></span></span>)</span> = <span class="mxinfo" id="T18:U420"><span class="mxinfo" id="T18:U421"><span class="mxinfo" id="T18:U422"><span class="mxinfo" id="T18:U423">repmat(<span class="mxinfo" id="T17:U424"><span class="var type1" id="S14T1U547">psfAmp</span>'</span>,<span class="var type1" id="S36T2U548">numPixel</span>,1)</span>.*(<span class="mxinfo" id="T18:U427"><span class="mxinfo" id="T18:U428"><span class="var type1" id="S34T18U553">psfValueY</span>(<span class="var type1" id="S38T1U554">relIndxY</span>,<span class="mxinfo" id="T30:U431">:</span>)</span>-<span class="keyword">...</span></span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183">183</a></span><span class="line"><span class="mxinfo" id="T18:U410"><span class="mxinfo" id="T18:U420"><span class="mxinfo" id="T18:U421"><span class="mxinfo" id="T18:U422"><span class="mxinfo" id="T18:U427">    <span class="mxinfo" id="T18:U432"><span class="var type1" id="S34T18U557">psfValueY</span>(<span class="mxinfo" id="T30:U434"><span class="var type1" id="S38T1U559">relIndxY</span>+<span class="mxinfo" id="T2:U436">1</span></span>,<span class="mxinfo" id="T30:U437">:</span>)</span></span>)</span>.*<span class="mxinfo" id="T18:U438"><span class="var type1" id="S23T18U563">psfIntegX</span>(<span class="var type1" id="S37T1U564">relIndxX</span>,<span class="mxinfo" id="T30:U441">:</span>)</span></span>.*<span class="mxinfo" id="T18:U442"><span class="var type1" id="S31T18U567">psfIntegZ</span>(<span class="var type1" id="S39T1U568">relIndxZ</span>,<span class="mxinfo" id="T30:U445">:</span>)</span></span></span>; <span class="comment">%w.r.t. y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184">184</a></span><span class="line"><span class="mxinfo" id="T18:U446"><span class="mxinfo" id="T18:U447"><span class="var type1" id="S2T18U573">J</span>(<span class="mxinfo" id="T30:U449">:</span>,<span class="mxinfo" id="T30:U450"><span class="mxinfo" id="T2:U451">3</span>:<span class="mxinfo" id="T2:U452">4</span>:<span class="mxinfo" id="T2:U453"><span class="mxinfo" id="T2:U454">4</span>*<span class="var type1" id="S10T2U581">numPSF</span></span></span>)</span> = <span class="mxinfo" id="T18:U456"><span class="mxinfo" id="T18:U457"><span class="mxinfo" id="T18:U458"><span class="mxinfo" id="T18:U459">repmat(<span class="mxinfo" id="T17:U460"><span class="var type1" id="S14T1U588">psfAmp</span>'</span>,<span class="var type1" id="S36T2U589">numPixel</span>,1)</span>.*(<span class="mxinfo" id="T18:U463"><span class="mxinfo" id="T18:U464"><span class="var type1" id="S35T18U594">psfValueZ</span>(<span class="var type1" id="S39T1U595">relIndxZ</span>,<span class="mxinfo" id="T30:U467">:</span>)</span>-<span class="keyword">...</span></span></span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185">185</a></span><span class="line"><span class="mxinfo" id="T18:U446"><span class="mxinfo" id="T18:U456"><span class="mxinfo" id="T18:U457"><span class="mxinfo" id="T18:U458"><span class="mxinfo" id="T18:U463">    <span class="mxinfo" id="T18:U468"><span class="var type1" id="S35T18U598">psfValueZ</span>(<span class="mxinfo" id="T30:U470"><span class="var type1" id="S39T1U600">relIndxZ</span>+<span class="mxinfo" id="T2:U472">1</span></span>,<span class="mxinfo" id="T30:U473">:</span>)</span></span>)</span>.*<span class="mxinfo" id="T18:U474"><span class="var type1" id="S23T18U604">psfIntegX</span>(<span class="var type1" id="S37T1U605">relIndxX</span>,<span class="mxinfo" id="T30:U477">:</span>)</span></span>.*<span class="mxinfo" id="T18:U478"><span class="var type1" id="S30T18U608">psfIntegY</span>(<span class="var type1" id="S38T1U609">relIndxY</span>,<span class="mxinfo" id="T30:U481">:</span>)</span></span></span>; <span class="comment">%w.r.t. z</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186">186</a></span><span class="line"><span class="mxinfo" id="T18:U482"><span class="mxinfo" id="T18:U483"><span class="var type1" id="S2T18U614">J</span>(<span class="mxinfo" id="T30:U485">:</span>,<span class="mxinfo" id="T30:U486"><span class="mxinfo" id="T2:U487">4</span>:<span class="mxinfo" id="T2:U488">4</span>:<span class="mxinfo" id="T2:U489"><span class="mxinfo" id="T2:U490">4</span>*<span class="var type1" id="S10T2U622">numPSF</span></span></span>)</span> = <span class="mxinfo" id="T18:U492"><span class="mxinfo" id="T18:U493"><span class="mxinfo" id="T18:U494"><span class="var type1" id="S23T18U626">psfIntegX</span>(<span class="var type1" id="S37T1U627">relIndxX</span>,<span class="mxinfo" id="T30:U497">:</span>)</span>.*<span class="mxinfo" id="T18:U498"><span class="var type1" id="S30T18U630">psfIntegY</span>(<span class="var type1" id="S38T1U631">relIndxY</span>,<span class="mxinfo" id="T30:U501">:</span>)</span></span>.*<span class="mxinfo" id="T18:U502"><span class="var type1" id="S31T18U634">psfIntegZ</span>(<span class="var type1" id="S39T1U635">relIndxZ</span>,<span class="mxinfo" id="T30:U505">:</span>)</span></span></span>; <span class="comment">%w.r.t. amp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,187">187</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,188">188</a></span><span class="line"><span class="comment">%remove pixels with NaN (which means they are out of the cropped image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,189">189</a></span><span class="line"><span class="comment">%area)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190">190</a></span><span class="line"><span class="mxinfo" id="T18:U506"><span class="var type1" id="S2T18U639">J</span> = <span class="mxinfo" id="T18:U508"><span class="var type1" id="S2T18U641">J</span>(<span class="var type1" id="S40T29U642">indxPixel</span>,<span class="mxinfo" id="T30:U511">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,191">191</a></span><span class="line"><span class="comment">%J = sparse(J);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192">192</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193">193</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,194">194</a></span><span class="line"><span class="comment">%% ~~ the end ~~</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,195">195</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,196">196</a></span><span class="line"><span class="comment">%% OLD CODE</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197">197</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,198">198</a></span><span class="line"><span class="comment">% % J = ones(numPixel,3*numPSF+1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199">199</a></span><span class="line"><span class="comment">% % F = ones(numPixel,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200">200</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201">201</a></span><span class="line"><span class="comment">% % for i=1:numPixel %for each pixel</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202">202</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203">203</a></span><span class="line"><span class="comment">% %     %get xy-indices relative to minimum</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204">204</a></span><span class="line"><span class="comment">% %     relIndxX = index(i,1) - minIndxX + 1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205">205</a></span><span class="line"><span class="comment">% %     relIndxY = index(i,2) - minIndxY + 1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206">206</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207">207</a></span><span class="line"><span class="comment">% %     %calculate the value of F</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,208">208</a></span><span class="line"><span class="comment">% %     F(i) = sum(psfAmp.*psfIntegX(relIndxX,:)'.*psfIntegY(relIndxY,:)') <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209">209</a></span><span class="line"><span class="comment">% %         + bgAmp - image(i);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,210">210</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,211">211</a></span><span class="line"><span class="comment">% %     %calculate the derivative wrt x-coordinate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212">212</a></span><span class="line"><span class="comment">% %     J(i,1:3:3*numPSF) = psfAmp'.*(psfValueX(relIndxX,:)-<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213">213</a></span><span class="line"><span class="comment">% %         psfValueX(relIndxX+1,:)).*psfIntegY(relIndxY,:)/psfSigma^2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,214">214</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215">215</a></span><span class="line"><span class="comment">% %     %calculate the derivative wrt y-coordinate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,216">216</a></span><span class="line"><span class="comment">% %     J(i,2:3:3*numPSF) = psfAmp'.*(psfValueY(relIndxY,:)-<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,217">217</a></span><span class="line"><span class="comment">% %         psfValueY(relIndxY+1,:)).*psfIntegX(relIndxX,:)/psfSigma^2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,218">218</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,219">219</a></span><span class="line"><span class="comment">% %     %calculate the derivative wrt amplitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,220">220</a></span><span class="line"><span class="comment">% %     J(i,3:3:3*numPSF) = psfIntegX(relIndxX,:).*psfIntegY(relIndxY,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,221">221</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,222">222</a></span><span class="line"><span class="comment">% %     %since the derivative wrt background intensity = 1, this is already</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223">223</a></span><span class="line"><span class="comment">% %     %accounted for in the initial assignment of J.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,224">224</a></span><span class="line"><span class="comment">% %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225">225</a></span><span class="line"><span class="comment">% % end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,226">226</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,227">227</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,228">228</a></span><span class="line"></span></span>
</pre>
